h1. Writing Apache Handlers in Ruby with mod_ruby

This is a step-by-step for writing handlers in Ruby.


h2. mod_ruby Handler Types

Apache provides a number of hooks for customizing the way it deals with incoming requests, and mod_ruby provides Apache directives for hooking your Ruby code into many of these stages. You can hook mostly everything that the other Apache modules do, resulting in a huge amount of flexibility and control over your server.

This guide will cover each of the directives, explaining when it is called, and showing several examples of how it can be used.

There are also a few other directives to control the environment of the embedded Ruby; for documentation on those, see "Apache Directives":directives.


h2. Handlers

The handlers are listed in the order they're executed:

!images/handler-order.png(Handler Order Diagram)!

h3. ChildInitHandler

bc. def child_init( server_request )

_[ed: only tested in the prefork model; still need to test what happens in the other MPMs]_

The ChildInitHandler is a special handler that's invoked when an Apache child first starts up, once per child, which allows you to do any of the work that needs to be done before requests are able to be served. This is useful, for example, to establish connections to a database, set up any expensive data structures, or to load further dependencies.

Note that the @request@ argument that's given to the handler isn't a full @Apache::Request@, as there's no actual request present, but it's populated with all of the server-global data.

Here's an example of establishing a database connection for each child which will later be available to the same handler object for all of the requests it handles:

<notextile>
<pre class="brush:ruby">
#!/usr/bin/env ruby -wKU

require 'pg'
require 'singleton'

class ChildDbInitHandler
    include Singleton

    ### Set up a database connection.
    def child_init( request )
        @conn = PGconn.connect( "host=localhost dbname=test" )
        request.server.log_info "Preconnect done: %p" % [ @conn ]
        return Apache::OK
    end

    ### Handle content, probably using the database connection.
    def handler( request )
        request.content_type = 'text/plain'
        request.puts "Database connection is: %p" % [ @conn ]
        return Apache::OK
    end

end
</pre>
</notextile>

This will connect to the database when the child first starts, and log that it's done so. The Apache config for this will look something like:

<notextile>
<pre>
RubyRequire child_db_inithandler
RubyChildInitHandler ChildDbInitHandler.instance

<Location /child_init_preconnect>
	SetHandler ruby-object
	RubyHandler ChildDbInitHandler.instance
</Location>
</pre>
</notextile>

When the server starts up, you'll see log messages like:

<notextile>
<pre>
[Sat Nov 13 13:41:13 2010] [notice] Apache/2.2.15 (Unix) mod_ruby/1.3.0 Ruby/1.8.7(2009-06-12) configured -- resuming normal operations
[Sat Nov 13 13:41:13 2010] [info] Server built: Aug 24 2010 11:47:29
[Sat Nov 13 13:41:13 2010] [debug] prefork.c(1013): AcceptMutex: posixsem (default: sysvsem)
[Sat Nov 13 13:41:14 2010] [info] Preconnect done: #<PGconn:0x1013331d0>
[Sat Nov 13 13:41:14 2010] [info] Preconnect done: #<PGconn:0x1013331d0>
[Sat Nov 13 13:41:14 2010] [info] Preconnect done: #<PGconn:0x1013331d0>
[Sat Nov 13 13:41:14 2010] [info] Preconnect done: #<PGconn:0x1013331d0>
[Sat Nov 13 13:41:14 2010] [info] Preconnect done: #<PGconn:0x1013331d0>
</pre>
</notextile>

h3. PostReadRequestHandler

bc. def post_read_request( request )

_[ed: only tested in the prefork model; still need to test what happens in the other MPMs]_

The PostReadRequestHandler, as its name indicates, is invoked immediately after the request has been read and its headers parsed.

This handler is usually used to do some task which needs to be done once per request. 

An example of something you can do with a combination of the @PostReadRequestHandler@ and the @LogHandler@ (covered a little later) is to examine the effect on the resource consumption of the Apache child for each request. Resource usage statistics are gathered immediately before the request, and then compared with the amounts after the request is finished, and the results are logged.

The example requires the @rusage@ gem.

<notextile>
<pre>
#!/usr/bin/env ruby -wKU

require 'singleton'
require 'rusage'

class RusageLogger
    include Singleton

	### Set up the handler's instance variables.
	def initialize
		@counter = 0
		@initial_usage = nil
	end


	######
	public
	######

    ### Set the initial usage right after the request is read.
    def post_read_request( request )
		# Only count the main request, not subrequests
		if request.main?
			@counter += 1
        	@initial_usage = Process.rusage
		end
        return Apache::DECLINED
    end

    ### Handle content, probably using the database connection.
    def log_transaction( request )
		if @initial_usage
			usage = Process.rusage

			maxrss_delta = usage.maxrss - @initial_usage.maxrss
			utime_delta  = usage.utime  - @initial_usage.utime
			stime_delta  = usage.stime  - @initial_usage.stime

			logmsg = "Usage deltas for child %d (after %d request/s): " %
				[ Process.pid, @counter ]
			logmsg << "rss: %0.1fKb, utime: %0.3f, stime: %0.3f" %
				[ maxrss_delta/1024.0, utime_delta, stime_delta ]

	        request.server.log_info( logmsg )
		end

        return Apache::DECLINED
    end

end
</pre>
</notextile>

You'd add this handler to your application like so:

<notextile>
<pre>
RubyRequire rubygems
RubyRequire rusagelogger
RubyPostReadRequestHandler RusageLogger.instance

<Location />
	...
	RubyLogHandler RusageLogger.instance
</Location>
</pre>
</notextile>

And the output might look something like:

<notextile>
<pre>
[Wed Dec 22 08:46:59 2010] [info] Usage deltas for child 57236 (after 1 request/s): \
	rss: 188.0Kb, utime: 0.001, stime: 0.001
[Wed Dec 22 08:47:27 2010] [info] Usage deltas for child 57238 (after 1 request/s): \
	rss: 168.0Kb, utime: 0.000, stime: 0.000
[Wed Dec 22 08:47:31 2010] [info] Usage deltas for child 57235 (after 2 request/s): \
	rss: 12.0Kb, utime: 0.000, stime: 0.000
[Wed Dec 22 08:47:40 2010] [info] Usage deltas for child 57236 (after 2 request/s): \
	rss: 24.0Kb, utime: 0.000, stime: 0.000
</pre>
</notextile>

h3. TransHandler translate_uri(#<Apache::Request:0x1020b2798>, [])



h3. AccessHandler check_access(#<Apache::Request:0x1020b2798>, [])

_To be done._

h3. TypeHandler find_types(#<Apache::Request:0x1020b2798>, [])

_To be done._

h3. FixupHandler fixup(#<Apache::Request:0x1020b2798>, [])

_To be done._

h3. RubyHandler: handler(#<Apache::Request:0x1020b2798>)

_To be done._

h3. LogHandler log_transaction(#<Apache::Request:0x1020b2798>, [])

_To be done._

h3. CleanupHandler cleanup(#<Apache::Request:0x1020a77d0>, [])

_To be done._

